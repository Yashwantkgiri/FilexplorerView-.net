@model FileExplorerApplicationV1.Models.FileExplorerViewModel
@{
    ViewData["Title"] = "File Explorer";
    var root = Model.RootFolder;
    var fileDetail = Model.SelectedFile;
    var currentProvider = ViewBag.CurrentProvider as string ?? "Local";
}

@functions {
    Microsoft.AspNetCore.Html.IHtmlContent RenderNode(FileExplorerApplicationV1.Models.FolderNode node)
    {
        if (node == null) return Html.Raw("");

        bool hasChildren = node.SubFolders.Any() || node.Files.Any();
        var html = new System.Text.StringBuilder();

        html.Append("<div class=\"mb-1\">");
        html.Append($"<div class=\"list-group-item list-group-item-action d-flex align-items-center folder-node\" data-path=\"{System.Text.Encodings.Web.HtmlEncoder.Default.Encode(node.FullPath)}\">");
        html.Append($"<i class=\"{(hasChildren ? "fas fa-caret-right me-2 caret" : "fas fa-folder me-2 text-warning")}\"></i>");
        html.Append($"<span>{Html.Encode(node.Name)}</span>");
        html.Append($"<small class=\"file-count\">({node.ChildCount})</small>");
        html.Append("</div>");

        if (hasChildren)
        {
            html.Append("<div class=\"children ps-3\">");

            foreach (var childFolder in node.SubFolders)
            {
                html.Append(RenderNode(childFolder).ToString());
            }

            foreach (var file in node.Files)
            {
                html.Append($"<div class=\"list-group-item list-group-item-action file-node\" data-path=\"{System.Text.Encodings.Web.HtmlEncoder.Default.Encode(file.FullPath)}\">");
                html.Append("<i class=\"fas fa-file-alt me-2 text-secondary\"></i>");
                html.Append($"<span>{Html.Encode(file.Name)}</span>");
                html.Append("</div>");
            }

            html.Append("</div>");
        }

        html.Append("</div>");
        return Html.Raw(html.ToString());
    }
}


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="~/css/site.css" />
</head>
<body class="bg-light d-flex flex-column vh-100">

    <!-- Header -->
    <nav class="navbar navbar-dark bg-primary px-3 d-flex justify-content-between align-items-center">
        <span class="navbar-brand mb-0 h1">
            <i class="fas fa-folder-open me-2"></i> File Explorer
        </span>

        <!-- Path Navigation Section -->
        <div class="d-flex align-items-center gap-3 flex-grow-1 mx-3">
            <div class="input-group" style="max-width: 600px;">
                <span class="input-group-text bg-light">
                    <i class="fas fa-map-marker-alt text-primary"></i>
                </span>
                <input type="text"
                       id="path-navigator"
                       class="form-control"
                       placeholder="Enter file or folder path (e.g., C:\Users\Documents\file.txt)"
                       title="Navigate to any file or folder by entering its full path"
                       style="min-width: 300px;" />
                <button id="navigate-btn"
                        class="btn btn-outline-light"
                        type="button"
                        title="Navigate to path">
                    <i class="fas fa-arrow-right"></i>
                    <span class="d-none d-md-inline ms-1">Go</span>
                </button>
            </div>

            <!-- Quick Navigation Buttons -->
            <div class="btn-group" role="group" aria-label="Quick navigation">
                <button id="home-btn"
                        class="btn btn-outline-light btn-sm"
                        title="Go to home directory"
                        onclick="window.fileExplorer?.navigateToPath('C:\\')">
                    <i class="fas fa-home"></i>
                </button>
                <button id="back-btn"
                        class="btn btn-outline-light btn-sm"
                        title="Go back"
                        disabled>
                    <i class="fas fa-arrow-left"></i>
                </button>
                <button id="up-btn"
                        class="btn btn-outline-light btn-sm"
                        title="Go up one level">
                    <i class="fas fa-arrow-up"></i>
                </button>
            </div>
        </div>
        <!-- Provider selection form - FIXED: Removed duplicate form tags -->
        <form asp-action="SetProvider" method="post" class="mt-3">
            <label for="providerSelect">Select Provider:</label>
            <select id="providerSelect" name="provider" onchange="this.form.submit()" class="form-select form-select-sm">
                <option value="Local" selected="@(currentProvider == "Local")">Local</option>
                <option value="FTP" selected="@(currentProvider == "FTP")">FTP</option>
                <option value="SFTP" selected="@(currentProvider == "SFTP")">SFTP</option>
            </select>
        </form>
    </nav>

    <div class="container-fluid flex-fill d-flex flex-column p-2">
        <div class="row flex-fill">

            <!-- Sidebar -->
            <aside id="folder-tree-view" class="col-12 col-md-3 col-lg-3 border-end overflow-auto">
                <div class="list-group list-group-flush tree-view h-100 
                    @{
                        void RenderNode(FileExplorerApplicationV1.Models.FolderNode node)
                        {
                            bool hasChildren = node.SubFolders.Any() || node.Files.Any();
                            <div class="mb-1">
                                <div class="list-group-item list-group-item-action d-flex align-items-center folder-node" data-path="@node.FullPath">
                                    <i class="@(hasChildren ? "fas fa-caret-right me-2 caret" : "fas fa-folder me-2 text-warning")"></i>
                                    <span>@node.Name</span>
                                    <small class="file-count">(@((node.SubFolders?.Count ?? 0) + (node.Files?.Count ?? 0)))</small>
                                </div>

                                @if (hasChildren)
                                {
                                    <div class="children ps-3">
                                        @foreach (var childFolder in node.SubFolders)
                                        {
                                            RenderNode(childFolder);
                                        }
                                        @foreach (var file in node.Files)
                                        {
                                            <div class="list-group-item list-group-item-action file-node" data-path="@file.FullPath">
                                                <i class="fas fa-file-alt me-2 text-secondary"></i>
                                                <span>@file.Name</span>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        }
                        RenderNode(root);
                    }
                </div>
            </aside>

            <!-- Main Panel -->
            <main id="main-content-area" class="col-12 col-md-9 col-lg-9 d-flex flex-column overflow-auto p-3">
                @if (fileDetail != null)
                {
                    <section class="file-details mb-3">
                        <h3>@fileDetail.Name</h3>
                        <dl class="row">
                            <dt class="col-3">Size:</dt>
                            <dd class="col-9">@fileDetail.FormattedSize</dd>
                            <dt class="col-3">Created:</dt>
                            <dd class="col-9">@fileDetail.Created.ToString("g")</dd>
                            <dt class="col-3">Modified:</dt>
                            <dd class="col-9">@fileDetail.Modified.ToString("g")</dd>
                            <dt class="col-3">Extension:</dt>
                            <dd class="col-9">@fileDetail.Extension</dd>
                        </dl>
                    </section>
                }
                <div id="placeholder" class="text-center text-muted my-auto">
                    <i class="fas fa-arrow-left fa-2x mb-2"></i>
                    <p>Select a folder to view its contents.</p>
                </div>

                <!-- Editor -->
                <div id="editor-container" class="editor-container d-none">
                    <div class="editor-header mb-2">
                        <button id="copy-doc-btn" class="btn btn-sm btn-secondary"><i class="fas fa-copy"></i> Copy Document</button>
                        <button id="copy-tag-btn" class="btn btn-sm btn-secondary"><i class="fas fa-tags"></i> Copy Tag</button>
                        <button id="copy-path-btn" class="btn btn-sm btn-secondary"><i class="fas fa-road"></i> Copy Path</button>
                    </div>
                    <div class="editor-body d-flex">
                        <div class="line-numbers" id="line-numbers"></div>
                        <pre class="code-content flex-fill" id="code-content-area"></pre>
                    </div>
                </div>
            </main>

        </div>
    </div>


    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js"></script>
</body>
</html>